name: Daily Snapsync Check

on:
  pull_request:
    branches: ["**"]
    paths:
      - ".github/workflows/daily_snapsync.yaml"
  schedule:
    # Every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      network:
        description: "Network name (hoodi or sepolia)"
        required: false
        default: "hoodi"

permissions:
  contents: read

concurrency:
  group: ethrex-sync-server
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.targets.outputs.matrix }}
    steps:
      - id: targets
        run: |
          event_name="${GITHUB_EVENT_NAME}"
          if [[ "$event_name" == "schedule" ]]; then
            json='[{"network":"hoodi","timeout":"40m"},{"network":"sepolia","timeout":"2h30m"}]'
          elif [[ "$event_name" == "pull_request" ]]; then
            json='[{"network":"hoodi","timeout":"40m"}]'
          else
            network=$(jq -r '.inputs.network // empty' "$GITHUB_EVENT_PATH")

            case "$network" in
              hoodi)
                json='[{"network":"hoodi","timeout":"40m"}]'
                ;;
              sepolia)
                json='[{"network":"sepolia","timeout":"2h30m"}]'
                ;;
              *)
                echo "::error::Unsupported network value '$network'. Allowed values: hoodi, sepolia."
                exit 1
                ;;
            esac
          fi
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  sync-lighthouse:
    needs: prepare
    name: Sync ${{ matrix.network }} - Lighthouse
    runs-on: ethrex-sync
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set start timestamp
        id: start
        run: |
          echo "timestamp=$EPOCHSECONDS" >> "$GITHUB_OUTPUT"

      - name: Run Snapsync Test
        uses: ./.github/actions/snapsync-run
        id: snapsync
        with:
          network: ${{ matrix.network }}
          timeout: ${{ matrix.timeout }}
          cl_type: lighthouse
          cl_image: "sigp/lighthouse:v8.0.1"

      - name: Post run on slack
        if: always()
        env:
          SLACK_WEBHOOK_URL_SUCCESS: ${{ secrets.ETHREX_NOTIFICATIONS_SLACK_WEBHOOK }}
          SLACK_WEBHOOK_URL_FAILURE: ${{ secrets.ETHREX_L1_SLACK_WEBHOOK }}
          REPO: ${{ github.repository }}
          NAME: "lighthouse-${{ matrix.network }}"
          OUTCOME: ${{ steps.snapsync.outcome }}
          HEAD_SHA: ${{ github.sha }}
          START_TIME: ${{ steps.start.outputs.timestamp }}
        run: |
          bash .github/scripts/notify_snapsync_run.sh

  sync-prysm:
    needs: prepare
    name: Sync ${{ matrix.network }} - Prysm
    runs-on: ethrex-sync
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set start timestamp
        id: start
        run: |
          echo "timestamp=$EPOCHSECONDS" >> "$GITHUB_OUTPUT"

      - name: Run Snapsync Test
        uses: ./.github/actions/snapsync-run
        id: snapsync
        with:
          network: ${{ matrix.network }}
          timeout: ${{ matrix.timeout }}
          cl_type: prysm
          cl_image: "gcr.io/offchainlabs/prysm/beacon-chain:v7.1.0"

      - name: Post run on slack
        if: always()
        env:
          SLACK_WEBHOOK_URL_SUCCESS: ${{ secrets.ETHREX_NOTIFICATIONS_SLACK_WEBHOOK }}
          SLACK_WEBHOOK_URL_FAILURE: ${{ secrets.ETHREX_L1_SLACK_WEBHOOK }}
          REPO: ${{ github.repository }}
          NAME: "prysm-${{ matrix.network }}"
          OUTCOME: ${{ steps.snapsync.outcome }}
          HEAD_SHA: ${{ github.sha }}
          START_TIME: ${{ steps.start.outputs.timestamp }}
        run: |
          bash .github/scripts/notify_snapsync_run.sh
